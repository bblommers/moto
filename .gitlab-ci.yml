cache:
  paths:
    - .cache/pip
    - venv/
  key: "$CI_JOB_IMAGE-$CI_COMMIT_REF_SLUG"
  # TODO: Change key to only CI_JOB_IMAGE
  # And empty cache when specific files are updated

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

stages:
  - "lint"
  - "test"

.venv:
    before_script:
        - "pip --version"
        - "pip install virtualenv"
        - "python -m virtualenv venv"
        - "source venv/bin/activate; pip install docker"
        - "source venv/bin/activate; pip show docker"
        - "service docker start"
        - "sleep 2 # Wait for docker"
        - "service docker status"
        - "docker info"
        - "source venv/bin/activate; python setup.py sdist"
        - "source venv/bin/activate; pip install --upgrade pip"
        - "source venv/bin/activate; pip install -r requirements-dev.txt"
        - "source venv/bin/activate; pip install docker>=2.5.1"
        - "source venv/bin/activate; pip install boto==2.45.0"
        - "source venv/bin/activate; pip install boto3"
        - "source venv/bin/activate; pip install dist/moto*.gz"
        - "source venv/bin/activate; pip install coveralls==1.1"
        - "source venv/bin/activate; pip install coverage==4.5.4"

lint:
  extends: .venv
  stage: lint
  image: "bblommers/python37docker:latest"
  script:
    - make lint

test-2.7:
  stage: test
  extends: .venv
  image: "bblommers/python27docker:latest"
  script:
    - make test-only

test-3.6:
  stage: test
  extends: .venv
  image: "bblommers/python36docker:latest"
  script:
    - make test-only

test-3.7:
  stage: test
  extends: .venv
  image: "bblommers/python37docker:latest"
  script:
    - make test-only

test-3.8:
  stage: test
  extends: .venv
  image: "bblommers/python38docker:latest"
  script:
    - make test-only